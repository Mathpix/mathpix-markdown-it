# PR: HTML Math Output Options and Browser Render Script

Status: Active
Owner: @OlgaRedozubova

---

## Context

Users exporting HTML from Mathpix products (Snip apps, v3/converter API) receive math rendered as SVG images. Many users want alternative formats:
- **MathML** for accessibility and native browser rendering
- **LaTeX source** for editing and client-side rendering

The current rendering pipeline already generates hidden MathML and LaTeX in the output, but only SVG is visible. Users cannot access the semantic formats without inspecting the HTML source.

Additionally, when users export HTML and open it in a browser, they lose the ability to right-click and copy math in different formats (a feature available in Snip preview).

This PR adds:
1. Options to control which math format is the primary visible output
2. A browser bundle for client-side rendering with Mathpix's MathJax customizations
3. A context menu for copying math in multiple formats

---

## Goal

1. Add options to `TOutputMath` interface to control primary math output format (SVG, MathML, or LaTeX)
2. Create a browser bundle (`mathpix-render.js`) for client-side LaTeX rendering
3. Create a context menu component for copying math in multiple formats from exported HTML

---

## Non-Goals

- Changing default behavior (SVG remains default)
- Modifying existing `include_*` options behavior
- Changes to DOCX, PDF, or other format rendering
- Offline bundling of MathJax (CDN approach for LaTeX option)

---

## Current Behavior

### Math Rendering Flow

1. LaTeX input is parsed by markdown-it with mathpix plugin
2. Math tokens are passed to MathJax for rendering
3. `OuterHTML` function assembles output with multiple formats
4. All formats except SVG are hidden with `style="display: none"`

### Current Output Structure

```html
<span class="math-inline">
  <latex style="display: none">\( x^2 + y = 1 \)</latex>
  <mathml style="display: none"><math>...</math></mathml>
  <asciimath style="display: none">x^2 + y = 1</asciimath>
  <mathmlword style="display: none">...</mathmlword>
  <mjx-container jax="SVG"><!-- Visible SVG --></mjx-container>
</span>
```

### Current Options

```typescript
interface TOutputMath {
  include_mathml?: boolean;
  include_mathml_word?: boolean;
  include_asciimath?: boolean;
  include_latex?: boolean;
  include_svg?: boolean;
  include_speech?: boolean;
  // ... other options
}
```

### Key Files

| File | Purpose |
|------|---------|
| `src/mathpix-markdown-model/index.ts` | Options interface, main API |
| `src/mathjax/index.ts` | MathJax rendering, `OuterHTML` assembly |
| `src/markdown/mdPluginRaw.ts` | `renderMath()` function |
| `src/markdown/common/convert-math-to-html.ts` | Math token to HTML conversion |

---

## Desired Behavior

### New Option

Add to `TOutputMath` interface:

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `math_output_format` | `'svg' \| 'mathml' \| 'latex'` | `'svg'` | Primary visible math format |

### Behavior by Format

| `math_output_format` | Server Output | Script Required | Offline |
|---------------------|---------------|-----------------|---------|
| `'svg'` (default) | Pre-rendered SVG | No | Yes |
| `'mathml'` | Native `<math>` elements | Yes (polyfill + features) | No |
| `'latex'` | Raw `\( \)` / `\[ \]` delimiters | Yes (rendering) | No |

### Why Script is Needed for MathML

- **Chrome has no native MathML support** - script provides polyfill
- **Context menu** - script generates hidden formats for copy functionality
- **Accessibility** - script adds `aria-label`, speech text
- **Consistent rendering** - ensures same appearance across browsers

### Hidden Formats and Context Menu

| `math_output_format` | Hidden Formats Source | Context Menu |
|---------------------|----------------------|--------------|
| `'svg'` | Server-generated via `include_*` options | Reads hidden elements |
| `'mathml'` | Client-generated by `mathpix-render.js` | Reads hidden elements |
| `'latex'` | Client-generated by `mathpix-render.js` | Reads hidden elements |

**Important:** For `'mathml'` and `'latex'` formats, the `include_*` options are ignored. The `mathpix-render.js` script generates hidden formats client-side for context menu and accessibility.

### Output Examples

**SVG output (`math_output_format: 'svg'`, default):**
```html
<span class="math-inline">
  <latex style="display: none">x^2</latex>
  <mathml style="display: none"><math>...</math></mathml>
  <mjx-container jax="SVG"><svg>...</svg></mjx-container>
</span>
```

**MathML output (`math_output_format: 'mathml'`):**
```html
<!-- Server outputs native MathML -->
<span class="math-inline">
  <math>...</math>
</span>
<!-- mathpix-render.js polyfills Chrome and adds hidden formats for context menu -->
```

**LaTeX output (`math_output_format: 'latex'`):**
```html
<!-- Server outputs raw delimiters -->
<p>The equation \( x^2 \) is inline.</p>
<p>\[ y = mx + b \]</p>
<!-- mathpix-render.js renders math and adds hidden formats for context menu -->
```

---

## Implementation

### Part 1: New Option in Interface

**File:** `src/mathpix-markdown-model/index.ts`

Add `math_output_format` option to `TOutputMath` interface:
- Type: `'svg' | 'mathml' | 'latex'`
- Default: `'svg'`

Update `optionsMathpixMarkdown` default values.

### Part 2: Rendering Logic Changes

**File:** `src/markdown/mdPluginRaw.ts`

Modify `renderMath()` function:
- Check `math_output_format` option
- When `'latex'`: return raw LaTeX with appropriate delimiters (`\( \)` for inline, `\[ \]` for display)
- When `'svg'` or `'mathml'`: proceed with MathJax rendering
- Preserve equation numbering context for all formats

**File:** `src/mathjax/index.ts`

Modify `OuterHTML()` function:
- Check `math_output_format` option
- When `'mathml'`: show MathML as primary, hide SVG container
- When `'svg'`: show SVG as primary (current behavior)
- Ensure MathML is unwrapped from `<mathml>` wrapper when it's the primary format

**File:** `src/markdown/common/convert-math-to-html.ts`

- Pass `math_output_format` option through to rendering functions
- When `'latex'`: bypass MathJax entirely, return raw delimiters

### Part 3: Browser Bundle

Create new directory: `src/browser/`

The browser bundle (`mathpix-render.js`) serves different purposes depending on the format:

| Format | Script Role |
|--------|-------------|
| `'svg'` | Optional - only for context menu if included |
| `'mathml'` | Required - Chrome polyfill + hidden formats + context menu |
| `'latex'` | Required - rendering + hidden formats + context menu |

**File:** `src/browser/auto-render.ts`

Entry point for client-side processing:

| Export | Description |
|--------|-------------|
| `renderMathInElement(element, config)` | Scan and render math in DOM element |
| `MathpixRender` | Global object with version and methods |

**Configuration options:**

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `delimiters` | `Array<{left, right, display}>` | `$$`, `\[\]`, `\(\)` | Math delimiter pairs |
| `outputFormat` | `'svg' \| 'mathml'` | `'svg'` | Render output format |
| `contextMenu` | `boolean` | `true` | Enable context menu |
| `ignoredTags` | `string[]` | `['script', 'pre', 'code']` | Elements to skip |
| `ignoredClasses` | `string[]` | `['no-mathpix']` | Classes to skip |

**Hidden formats options (for context menu):**

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `include_latex` | `boolean` | `true` | Generate hidden LaTeX for copy |
| `include_mathml` | `boolean` | `true` | Generate hidden MathML for copy |
| `include_asciimath` | `boolean` | `false` | Generate hidden AsciiMath for copy |
| `include_mathml_word` | `boolean` | `false` | Generate hidden Word MathML for copy |

These options mirror the server-side `include_*` options and control which formats are available in the context menu when the script generates hidden elements client-side.

**Behavior:**
- On DOMContentLoaded, detect content type (LaTeX delimiters or MathML elements)
- For LaTeX: scan for delimiters, render using `MathpixMarkdownModel.markdownToHTML()`
- For MathML: detect browser support, polyfill Chrome if needed
- Generate hidden format elements (LaTeX, MathML, AsciiMath) for context menu
- Add accessibility attributes (`aria-label`, speech text)
- Initialize context menu if enabled

**File:** `src/browser/context-menu.ts`

Right-click menu for math elements:

| Menu Item | Source | Action |
|-----------|--------|--------|
| Copy LaTeX | `<latex>` element | Copy text to clipboard |
| Copy MathML | `<mathml>` element | Copy text to clipboard |
| Copy AsciiMath | `<asciimath>` element | Copy text to clipboard |
| Copy MathML (Word) | `<mathmlword>` element | Copy text to clipboard |
| Copy as Image | `<svg>` element | Convert to PNG, copy to clipboard |

**Behavior:**
- Listen for `contextmenu` event on `.math-inline`, `.math-block`, `mjx-container`
- Show menu only with items for available formats (check if elements exist)
- Use Clipboard API for copying
- Show toast notification on success

**File:** `src/browser/styles.css`

Styles for context menu and toast notifications.

### Part 4: Build Configuration

**File:** `rollup.browser.config.js` (new)

Rollup config for browser bundle:
- Input: `src/browser/auto-render.ts`
- Output: `dist/mathpix-render.js` and `dist/mathpix-render.min.js`
- Format: IIFE with `MathpixRender` global
- Include terser for minification

**File:** `package.json`

Add build scripts:
- `build:browser`: Build browser bundle
- `build`: Include browser build in main build

Add files to package exports:
- `dist/mathpix-render.js`
- `dist/mathpix-render.min.js`
- `dist/mathpix-render.css`

---

## Distribution

Browser bundle included in npm package, accessible via jsdelivr:
- `https://cdn.jsdelivr.net/npm/mathpix-markdown-it@{version}/dist/mathpix-render.min.js`
- `https://cdn.jsdelivr.net/npm/mathpix-markdown-it@{version}/dist/mathpix-render.css`

This follows the existing pattern for `es5/bundle.js`.

---

## Usage Examples

### Server-Side: MathML Output

```typescript
import { MathpixMarkdownModel } from 'mathpix-markdown-it';

const html = MathpixMarkdownModel.markdownToHTML(mmd, {
  outMath: {
    math_output_format: 'mathml',
    include_latex: true,  // Keep LaTeX for context menu
  }
});
```

### Server-Side: LaTeX Output (for Client Rendering)

```typescript
const html = MathpixMarkdownModel.markdownToHTML(mmd, {
  outMath: {
    math_output_format: 'latex',
  }
});
// HTML contains raw \( \) and \[ \] delimiters
// Include mathpix-render.js to render client-side
```

### Client-Side: Auto-Render

```html
<script>
  window.MathpixRenderConfig = {
    outputFormat: 'svg',
    contextMenu: true,
    // Hidden formats for context menu
    include_latex: true,
    include_mathml: true,
    include_asciimath: false,
    include_mathml_word: false
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathpix-markdown-it@latest/dist/mathpix-render.min.js"></script>
```

### Client-Side: Manual Render

```javascript
MathpixRender.renderMathInElement(document.getElementById('content'), {
  delimiters: [
    { left: '$$', right: '$$', display: true },
    { left: '$', right: '$', display: false }
  ]
});
```

---

## Constraints / Invariants

- Default behavior unchanged (`math_output_format: 'svg'`)
- Existing `include_*` options only apply to `'svg'` format
- When `math_output_format: 'mathml'` or `'latex'`, `include_*` options are ignored (script handles this)
- Context menu only shows items for formats present in HTML
- Browser bundle must work standalone (no external dependencies except DOM)
- `mathpix-render.js` is required for `'mathml'` (Chrome polyfill) and `'latex'` (rendering)
- Only `'svg'` format works offline; `'mathml'` and `'latex'` require CDN script

---

## Testing

### Unit Tests

- `math_output_format: 'svg'` produces SVG as primary (default behavior)
- `math_output_format: 'mathml'` produces native MathML elements
- `math_output_format: 'latex'` outputs raw LaTeX delimiters, no MathJax rendering
- `include_*` options work with `'svg'` format only
- `include_*` options ignored when `math_output_format: 'mathml'` or `'latex'`
- Inline vs display math handled correctly for all formats
- Equation numbering preserved with all formats

### Integration Tests

- Browser bundle loads without errors
- Auto-render finds and renders math delimiters
- Context menu appears on right-click
- Copy functions work with Clipboard API
- Ignored tags/classes are skipped

### Manual Tests

- Verify rendered output matches Snip preview
- Test context menu in Chrome, Firefox, Safari
- Test MathML rendering in Firefox (native) vs Chrome (polyfill needed)

---

## Done When

- [ ] `math_output_format` option added to `TOutputMath` interface
- [ ] `renderMath()` handles all three format values (`'svg'`, `'mathml'`, `'latex'`)
- [ ] `OuterHTML()` shows correct primary format based on option
- [ ] Browser bundle entry point created (`src/browser/auto-render.ts`)
- [ ] Context menu implemented (`src/browser/context-menu.ts`)
- [ ] Rollup config for browser bundle
- [ ] Build scripts added to package.json
- [ ] Bundle files included in npm package
- [ ] Unit tests for new options
- [ ] Integration tests for browser bundle
- [ ] README updated with new options and browser bundle usage
- [ ] Changelog updated
- [ ] `Status` updated to `Implemented`

---

## Related

- Monorepo PR spec: `monorepo/pr-specs/2026-01-snip-html-export-mathml-option.md`
- Consumers: mmd-converter (v3/converter API), snip-web, desktop apps
